#!/usr/bin/env bash
# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Description
#   This script tries to setup a debug version of the Flash Player on Linux 64bits systems.
#   Should work on Debian and Ubuntu, at least for Firefox.
#   Use it at your own risk !
# ──────────────────────────────────────────────────────────────────────────────────────────────────


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Constants
# ──────────────────────────────────────────────────────────────────────────────────────────────────

# Download URLs
FLASH_PLAYER_DOWNLOAD_URL=http://download.macromedia.com/pub/flashplayer/updaters/10/flash_player_10_linux_dev.tar.gz

# Colors 
BOLD=`tput bold` 
RED=`tput setaf 1` 
GREEN=`tput setaf 2` 
YELLOW=`tput setaf 3` 
BLUE=`tput setaf 4` 
RESET_FORMATTING=`tput sgr0` 


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────────────────────────

# Output an info message.
function info()
{
  echo -e "$BOLD$@$RESET_FORMATTING"
}

# Output an warning message.
function warn()
{
  echo -e "$BOLD$YELLOW$@$RESET_FORMATTING" 2>&1
}

# Output an error message.
function error()
{
  echo -e "$BOLD$RED$@$RESET_FORMATTING" 2>&1
}

# Display a title.
title()
{
  echo -e "$BOLD$BLUE──────────────────────────────$RESET_FORMATTING"
  echo -e "$BOLD$BLUE $@$RESET_FORMATTING"
  echo -e "$BOLD$BLUE──────────────────────────────$RESET_FORMATTING"
}

# Make sure we have root access
is_root()
{
  [[ `id -u` -eq 0 ]] && return 0
  return 1
}

#
is_64bits()
{
  [[ `uname -m` == 'x86_64' ]] && return 0
  return 1
}

# Ask a Yes/No question
ask() {
  echo -n "$@" '[y/N] ' ; read ans
  case "$ans" in
    y*|Y*) return 0 ;;
    *) return 1 ;;
  esac
}

#
uninstall_flash_player()
{
  if ask "This will erase any existing installation of the Flash Player. Are you sure you want to continue ?"; then
    info "Uninstalling packages"
    apt-get --assume-yes --purge -qq remove flashplugin-installer
    apt-get --assume-yes --purge -qq remove adobe-flashplugin
    apt-get --assume-yes --purge -qq remove nspluginwrapper
    apt-get --assume-yes --purge -qq remove flashplugin-nonfree
    apt-get --assume-yes --purge -qq remove gnash
    apt-get --assume-yes --purge -qq remove gnash-common
    apt-get --assume-yes --purge -qq remove mozilla-plugin-gnash
    apt-get --assume-yes --purge -qq remove iceweasel-flashplugin
    apt-get --assume-yes --purge -qq remove mozilla-flashplugin
    apt-get --assume-yes --purge -qq remove firefox-flashplugin
    apt-get --assume-yes --purge -qq remove swfdec-mozilla
    apt-get --assume-yes --purge -qq remove mozilla-swfdec
    apt-get --assume-yes --purge -qq remove libflashsupport
    apt-get --assume-yes --purge -qq remove iceape-flashplugin
    apt-get --assume-yes --purge -qq remove xulrunner-flashplugin
    apt-get --assume-yes --purge -qq remove midbrowser-flashplugin
    apt-get --assume-yes --purge -qq remove xulrunner-addons-flashplugin
    apt-get --assume-yes --purge -qq remove nspluginwrapper
    
    info "Cleaning traces from any previous Flash Player installation"
    rm -rvf /home/*/.mozilla/plugins/libflash* \
            /home/*/.mozilla/plugins/ns*flash* \
            /usr/lib/firefox*/plugins/libflash* \
            /usr/lib/iceape/plugins/flash*.so \
            /usr/lib/iceweasel/plugins/flash*.so \
            /usr/lib/iceweasel/plugins/npwrapper.libflashplayer.so \
            /usr/lib/midbrowser/plugins/flash*.so \
            /usr/lib/mozilla/plugins/libflash* \
            /usr/lib/xulrunner-addons/plugins/flashplugin-alternative.so \
            /usr/lib/xulrunner/plugins/flash*.so \
            /usr/lib/nspluginwrapper \
            /var/lib/flashplugin-nonfree/npwrapper.libflashplayer.so
  fi
}

#
install_flash_player_by_package_manager()
{
  info "Installing Flash Player with the package manager"
  apt-get --assume-yes --quiet install flashplugin-installer
  return $?
}

patch_libflashplayer_with_debug_one()
{
  info "Replacing libflashplayer.so"
  wget -qO- $FLASH_PLAYER_DOWNLOAD_URL | tar xvzO flash_player_10_linux_dev/plugin/debugger/libflashplayer.so.tar.gz \
                                       | tar xvzO libflashplayer.so \
                                       > /usr/lib/flashplugin-installer/libflashplayer.so
  return $?
}

#
install_flash_player()
{
  title "Install Flash player"
  uninstall_flash_player && install_flash_player_by_package_manager
  return $?
}

install_flash_player_debug()
{
  title "Install Flash player debug"
  uninstall_flash_player && install_flash_player_by_package_manager && patch_libflashplayer_with_debug_one
  return $?
}


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────────────────────────

if ! is_root; then
  warn "This script must be run as root. Don't worry, we'll be careful..."
  su --login root --command "$0 $*"
  exit $?
fi

title "Flash Player setup script"

choices=( 'Install Flash Player' \
		  'Install Flash Player debug' \
		  'Install standalone Flash Player' \
		  'Install standalone Flash Player debug' \
		  'Uninstall Flash Player' \
		  'Exit' )

echo "What do you want to do ?"
PS3="Choose a number: "
select choice in "${choices[@]}"
do
  case $choice in
    'Install Flash Player')
      install_flash_player
      exit $?
      ;;
    'Install Flash Player debug')
      install_flash_player_debug
      exit $?
      ;;
    'Install standalone Flash Player')
      if is_64bits; then
        error "Install 64 bits standalone Flash Player: not yet implemented."
      else
        error "Install 32 bits standalone Flash Player: not yet implemented."
      fi
      exit 0
      ;;
    'Install standalone Flash Player debug')
      if is_64bits; then
        error "Install 64 bits standalone Flash Player debug: not yet implemented."
      else
        error "Install 32 bits standalone Flash Player debug: not yet implemented."
      fi
      exit 0
      ;;
    'Uninstall Flash Player')
      uninstall_flash_player
      exit $?
      ;;
    'Exit')
      exit 0
      ;;
  esac
done
