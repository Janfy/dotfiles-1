#!/usr/bin/env bash
# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Description
#   Helper script to install/uninstall stantard/debugger plugin/standalone Flash Player on 32/64
#   bits systems. Tested on Ubuntu, should work on Debian as well. Use it at your own risk !
#
# Usage
#   $ ./flash-tool
# ──────────────────────────────────────────────────────────────────────────────────────────────────


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Constants
# ──────────────────────────────────────────────────────────────────────────────────────────────────

# Flash Player distributions
FLASH_PLAYER_DOWNLOAD_URL=http://download.macromedia.com/pub/flashplayer/updaters/10/flash_player_10_linux_dev.tar.gz
FLASH_PLAYER_BETA_DOWNLOAD_URL=http://download.macromedia.com/pub/labs/flashplayer10/flashplayer10_1_rc4_linux_050510.tar.gz
FLASH_PLAYER_DEBUG_BETA_DOWNLOAD_URL=http://download.macromedia.com/pub/labs/flashplayer10/flashplayer10_1_rc4_debug_linux_050510.tar.gz

# Installation places
LIBFLASHPLAYER_LOCATION=/usr/lib/flashplugin-installer/libflashplayer.so
STANDALONE_FLASH_PLAYER_LOCATION=/usr/local/bin/flashplayer
STANDALONE_FLASH_PLAYER_DEBUG_LOCATION=/usr/local/bin/flashplayer-debug

# Colors 
BOLD=`tput bold` 
RED=`tput setaf 1` 
GREEN=`tput setaf 2` 
YELLOW=`tput setaf 3` 
BLUE=`tput setaf 4` 
RESET_FORMATTING=`tput sgr0` 


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────────────────────────

# Output an info message.
#
# Arguments
#   1 (required) The message to log.
info()
{
  echo -e "$BOLD$@$RESET_FORMATTING"
}

# Output a warning message.
#
# Arguments
#   1 (required) The message to log.
warn()
{
  echo -e "$YELLOW$@$RESET_FORMATTING" 2>&1
}

# Output an error message.
#
# Arguments
#   1 (required) The message to log.
error()
{
  echo -e "$BOLD$RED$@$RESET_FORMATTING" 2>&1
}

# Display a title.
#
# Arguments
#   1 (required) The title to show.
title()
{
  echo -e "$BLUE──────────────────────────────$RESET_FORMATTING"
  echo -e "$BOLD$BLUE $@$RESET_FORMATTING"
  echo -e "$BLUE──────────────────────────────$RESET_FORMATTING"
}

# Test if the user running the script is root.
is_root()
{
  [[ `id -u` -eq 0 ]] || return 1
}

# Ask a Yes/No question.
#
# Arguments
#   1 (required) The question to ask.
ask() {
  echo -ne "$@" '[y/N] '; read ans
  case "$ans" in
    y*|Y*) return 0 ;;
    *) return 1 ;;
  esac
}

# Force the user to shutdown its browsers.
enforce_no_browser_running()
{
  info "Checking no browser is currently running"

  while ps -A | egrep -q 'firefox-bin|chrome|opera|iceweasel'
  do
    warn "It seems you have web browsers running. Please shut them down before proceeding."
    read -p "Press any key to continue..."
  done
}

# Try to clean any trace from a Flash Player installation.
erase_all_flash_player_plugin()
{
  ask "This will erase any existing installation of the Flash Player plugin. Are you sure you want to continue ?" || return 1

  info "Uninstalling packages"
  apt-get --assume-yes --purge -qq remove flashplugin-installer
  apt-get --assume-yes --purge -qq remove adobe-flashplugin
  apt-get --assume-yes --purge -qq remove nspluginwrapper
  apt-get --assume-yes --purge -qq remove flashplugin-nonfree
  apt-get --assume-yes --purge -qq remove gnash
  apt-get --assume-yes --purge -qq remove gnash-common
  apt-get --assume-yes --purge -qq remove mozilla-plugin-gnash
  apt-get --assume-yes --purge -qq remove iceweasel-flashplugin
  apt-get --assume-yes --purge -qq remove mozilla-flashplugin
  apt-get --assume-yes --purge -qq remove firefox-flashplugin
  apt-get --assume-yes --purge -qq remove swfdec-mozilla
  apt-get --assume-yes --purge -qq remove mozilla-swfdec
  apt-get --assume-yes --purge -qq remove libflashsupport
  apt-get --assume-yes --purge -qq remove iceape-flashplugin
  apt-get --assume-yes --purge -qq remove xulrunner-flashplugin
  apt-get --assume-yes --purge -qq remove midbrowser-flashplugin
  apt-get --assume-yes --purge -qq remove xulrunner-addons-flashplugin
  apt-get --assume-yes --purge -qq remove nspluginwrapper
  
  info "Cleaning traces from any previous Flash Player installation"
  rm -rvf /home/*/.mozilla/plugins/libflash* \
      /home/*/.mozilla/plugins/ns*flash* \
      /usr/lib/firefox*/plugins/libflash* \
      /usr/lib/iceape/plugins/flash*.so \
      /usr/lib/iceweasel/plugins/flash*.so \
      /usr/lib/iceweasel/plugins/npwrapper.libflashplayer.so \
      /usr/lib/midbrowser/plugins/flash*.so \
      /usr/lib/mozilla/plugins/libflash* \
      /usr/lib/xulrunner-addons/plugins/flashplugin-alternative.so \
      /usr/lib/xulrunner/plugins/flash*.so \
      /usr/lib/nspluginwrapper \
      /var/lib/flashplugin-nonfree/npwrapper.libflashplayer.so
  
}

# Totally uninstall the Flash player plugin.
uninstall_flash_player_plugin()
{
  enforce_no_browser_running
  erase_all_flash_player_plugin || return 1
}

# Install the "official" Flash Player package.
install_flash_player_by_package_manager()
{
  info "Installing Flash Player with the package manager"
  apt-get --assume-yes --quiet install flashplugin-installer || return 1
}

# Install the standard Flash Player plugin.
install_flash_player_plugin()
{
  title "Install Flash player plugin"
  enforce_no_browser_running
  erase_all_flash_player_plugin || return 1
  install_flash_player_by_package_manager || return 1
}

# Install the debugger Flash Player plugin.
install_flash_player_debug_plugin()
{
  title "Install Flash player debug plugin"
  enforce_no_browser_running
  erase_all_flash_player_plugin || return 1
  install_flash_player_by_package_manager || return 1
  
  info "Downloading, extracting libflashplayer.so and patching it"
  wget -qO- $FLASH_PLAYER_DOWNLOAD_URL | tar xvzO flash_player_10_linux_dev/plugin/debugger/libflashplayer.so.tar.gz \
                                       | tar xvzO libflashplayer.so \
                                       > $LIBFLASHPLAYER_LOCATION \
                                       || return 1
}

# Install the beta Flash Player plugin.
install_flash_player_beta_plugin()
{
  title "Install Flash player beta plugin"
  enforce_no_browser_running
  erase_all_flash_player_plugin || return 1
  install_flash_player_by_package_manager || return 1
  
  info "Downloading, extracting libflashplayer.so and patching it"
  wget -qO- $FLASH_PLAYER_BETA_DOWNLOAD_URL | tar xvzO libflashplayer.so \
                                            > $LIBFLASHPLAYER_LOCATION \
                                            || return 1
}

# Install the debugger beta Flash Player plugin.
install_flash_player_debug_beta_plugin()
{
  title "Install Flash player debug beta plugin"
  enforce_no_browser_running
  erase_all_flash_player_plugin || return 1
  install_flash_player_by_package_manager || return 1
  
  info "Downloading, extracting libflashplayer.so and patching it"
  wget -qO- $FLASH_PLAYER_DEBUG_BETA_DOWNLOAD_URL | tar xvzO libflashplayer.so \
                                                  > $LIBFLASHPLAYER_LOCATION \
                                                  || return 1
}

# Install the standalone Flash Player.
install_standalone_flash_player()
{
  title "Install standalone Flash player"
  
  enforce_no_browser_running
  
  info "Downloading and extracting the standalone Flash Player executable"
  wget -qO- $FLASH_PLAYER_DOWNLOAD_URL | tar xvzO flash_player_10_linux_dev/standalone/release/flashplayer.tar.gz \
                                       | tar xvzO flashplayer \
                                       > $STANDALONE_FLASH_PLAYER_LOCATION \
                                       || return 1
  chmod +x $STANDALONE_FLASH_PLAYER_LOCATION
  info "The standalone Flash Player has been installed at '$STANDALONE_FLASH_PLAYER_LOCATION'."
}

# Install the standalone debug Flash Player.
install_standalone_flash_player_debug()
{
  title "Install standalone Flash player debug"
  
  enforce_no_browser_running
  
  info "Downloading and extracting the standalone Flash Player debug executable"
  wget -qO- $FLASH_PLAYER_DOWNLOAD_URL | tar xvzO flash_player_10_linux_dev/standalone/debugger/flashplayer.tar.gz \
                                       | tar xvzO flashplayer \
                                       > $STANDALONE_FLASH_PLAYER_DEBUG_LOCATION \
                                       || return 1
  chmod +x $STANDALONE_FLASH_PLAYER_DEBUG_LOCATION
  info "The standalone Flash Player debug has been installed at '$STANDALONE_FLASH_PLAYER_DEBUG_LOCATION'."
}

# Setup a workaround for the "Can't click on Flash" bug on Ubuntu 9.10+.
fix_no_click_bug()
{
  title 'Fix the "Cannot click on Flash" bug'

  local PATCHED_SCRIPT=/usr/lib/nspluginwrapper/i386/linux/npviewer

  if [[ ! -e $PATCHED_SCRIPT ]]; then
    error "The script to patch could not be found."
    return 1
  fi

  if grep -q 'GDK_NATIVE_WINDOWS=1' $PATCHED_SCRIPT; then
    warn "The fix was already applied."
    return 1
  fi

  enforce_no_browser_running || return 1

  info "Patching nspluginwrapper init script"
  sed '2i\GDK_NATIVE_WINDOWS=1' -i $PATCHED_SCRIPT

  info "Killing all instances of nspluginwrapper"
  killall npviewer.bin
}


# ──────────────────────────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────────────────────────

# Enforce root privileges.
if ! is_root; then
  warn "This script must be run as root. Don't worry, we'll be careful..."
  su --login root --command "$0 $*"
  exit $?
fi

# Show a banner.
title "Flash tool"

# Make the user choose in a menu.
choices=( 'Install Flash Player plugin' \
          'Install Flash Player beta plugin' \
          'Install Flash Player debug plugin' \
          'Install Flash Player debug beta plugin' \
          'Install standalone Flash Player' \
          'Install standalone Flash Player debug' \
          'Uninstall Flash Player plugin' \
          'Fix the "Cannot click on Flash" bug' \
          'Exit' )
echo "What do you want to do ?"
PS3="Choose a number: "
select choice in "${choices[@]}"
do
  case $choice in
    'Install Flash Player plugin')
      install_flash_player_plugin
      exit $?
      ;;
    'Install Flash Player beta plugin')
      install_flash_player_beta_plugin
      exit $?
      ;;
    'Install Flash Player debug plugin')
      install_flash_player_debug_plugin
      exit $?
      ;;
    'Install Flash Player debug beta plugin')
      install_flash_player_debug_beta_plugin
      exit $?
      ;;
    'Install standalone Flash Player')
      install_standalone_flash_player
      exit $?
      ;;
    'Install standalone Flash Player debug')
      install_standalone_flash_player_debug
      exit $?
      ;;
    'Uninstall Flash Player plugin')
      uninstall_flash_player_plugin
      exit $?
      ;;
    'Fix the "Cannot click on Flash" bug')
      fix_no_click_bug
      exit $?
      ;;
    'Exit')
      exit 0
      ;;
  esac
done
